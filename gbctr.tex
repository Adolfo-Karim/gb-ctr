\include{config}

\ifnum \draft=1
  \documentclass[a4paper, draft, oneside]{memoir}
\else
  \documentclass[a4paper, oneside]{memoir}
\fi

\usepackage[final]{graphicx}
\usepackage[english]{babel}
\usepackage{fontspec}
\usepackage[T1]{fontenc}
\usepackage{charter}
\usepackage{mathpazo}
\usepackage[ttdefault=true]{AnonymousPro}
\usepackage{tabu}
\usepackage{pdflscape}
\usepackage{enumitem}
\usepackage{ccicons}
\usepackage[svgnames,table]{xcolor}
\usepackage{tikz}
\usepackage{tikz-timing}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{minted}
\usepackage{enumitem}
\usepackage[most]{tcolorbox}
\usepackage{fontawesome}
\usepackage{hyperref}
\usepackage[all]{hypcap}

% aliases to support old fontawesome package versions
\providecommand\faArrowCircleDown{\faCircleArrowDown}
\providecommand\faArrowCircleUp{\faCircleArrowUp}
\providecommand\faArrowCircleRight{\faCircleArrowRight}
\providecommand\faArrowCircleLeft{\faCircleArrowLeft}

\usemintedstyle{autumn}

\graphicspath{{images/}}

\include{revision}

\bibliographystyle{plain}

\title{Game Boy: Complete Technical Reference}
\author{gekkio\\ \url{https://gekkio.fi}}
\renewcommand{\maketitlehookd}{
  \begin{center}
    Revision \Revision

    \ifdraftdoc
      DRAFT!
    \fi

    \vfill

    \href{http://creativecommons.org/licenses/by-sa/4.0/}{\Huge \ccbysa}

    This work is licensed under a \href{http://creativecommons.org/licenses/by-sa/4.0/}{Creative Commons Attribution-ShareAlike 4.0 International License}.
  \end{center}
}

\ifdraftdoc
  \makeevenfoot{plain}{}{\thepage}{\textit{DRAFT! \Revision}}
  \makeoddfoot{plain}{\textit{DRAFT! \Revision}}{\thepage}{}
  \makeevenfoot{headings}{}{}{\textit{DRAFT! \Revision}}
  \makeoddfoot{headings}{\textit{DRAFT! \Revision}}{}{}
\fi

\hypersetup{final,unicode=true,pdfborder={0 0 0},bookmarksnumbered=true,pdfpagemode=UseOutlines,pdfauthor=gekkio,pdftitle=\thetitle}

\setlrmarginsandblock{2cm}{2cm}{*}
\setulmarginsandblock{2cm}{2cm}{*}
\checkandfixthelayout

\newtcolorbox{speculation}
{colframe=SteelBlue,colback=Azure,title=\faPuzzlePiece,fonttitle=\small}

\newtcolorbox{caveat}
{colframe=Crimson,colback=MistyRose,title=\faExclamation,fonttitle=\small}

\floatstyle{plaintop}
\newfloat{register}{h}{lor}[chapter]
\floatname{register}{Register}

\begin{document}

\hypersetup{pageanchor=false}

\begin{titlingpage}
  \calccentering{\unitlength}
  \setlength{\droptitle}{80pt}
  \begin{adjustwidth*}{\unitlength}{-\unitlength}
    \maketitle
  \end{adjustwidth*}
\end{titlingpage}

\hypersetup{pageanchor=true}

\tableofcontents

\chapter*{Introduction}

\chapter*{How to read this document}

\begin{speculation}
  This is something that hasn't been verified, but would make a lot of sense.
\end{speculation}

\begin{caveat}
  This explains some caveat about this documentation that you should know.
\end{caveat}

\begin{register}[H]
  \caption{\texttt{\$1234} - This is a hardware register definition}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0    & R/W-1      & U-1     & R/W-0      & R/W-0       & R/W-0         & R/W-0       & R/W-0      \\
      \multicolumn2{|c|}{VALUE<1:0>} & \cellcolor{LightGray} - & & & & & \\
      \rowfont{\rmfamily\small}
      bit 7    & 6          & 5         & 4          & 3           & 2             & 1           & bit 0      \\
      \hline
    \end{tabu}
  }

  \textbf{Top row legend:}
  \begin{description}[leftmargin=5em, style=nextline]
    \item[R]
      Bit can be read.
    \item[W]
      Bit can be written. If the bit cannot be read, reading returns a constant
      value defined in the bit list of the register in question.
    \item[U]
      Unimplemented bit. Writing has no effect, and reading returns a constant
      value defined in the bit list of the register in question.
    \item[-n]
      Value after reset: \texttt{0}, \texttt{1}, x.
    \item[\texttt{1}]
      Bit is set.
    \item[\texttt{0}]
      Bit is cleared.
    \item[x]
      Bit is unknown (e.g. depends on external things such as user input).
  \end{description}

  \textbf{Middle row legend:} \\
  {
    \ttfamily
    \begin{tabu} to 0.5\textwidth {|X[l]|X[c]|}
      \everyrow{\hline}
      \hline
      VALUE & \rmfamily A single-bit value \\
      VALUE<1:0> & \rmfamily Bits 1 and 0 of VALUE \\
      VALUE<7:4> & \rmfamily Bits 7, 6, 5, 4 of VALUE \\
      \cellcolor{LightGray} - & \rmfamily Unimplemented bit \\
      \hline
    \end{tabu}
  }
\end{register}

\part{Game Boy CPU and the Sharp LR35902 instruction set}

\part{Game Boy CPU peripherals}

\chapter{PPU (Picture Processing Unit)}

\begin{register}[H]
  \caption{\texttt{\$FF40} - LCDC - PPU control register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0    & R/W-0      & R/W-0     & R/W-0      & R/W-0       & R/W-0         & R/W-0       & R/W-0      \\
      LCD\_EN & WIN\_MAP & WIN\_EN & TILE\_SEL & BG\_MAP & OBJ\_SIZE & OBJ\_EN & BG\_EN \\
      \rowfont{\rmfamily\small}
      bit 7    & 6          & 5         & 4          & 3           & 2             & 1           & bit 0      \\
      \hline
    \end{tabu}
  }
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF41} - LCDC - PPU status register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      U-1 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \cellcolor{LightGray} - & INTR\_LYC & INTR\_M2 & INTR\_M1 & INTR\_M0 & LYC\_STAT & \multicolumn2{c|}{LCD\_MODE<1:0>} \\
      \rowfont{\rmfamily\small}
      bit 7    & 6          & 5         & 4          & 3           & 2             & 1           & bit 0      \\
      \hline
    \end{tabu}
  }
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF42} - SCY - Vertical scroll register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \multicolumn8{|c|}{SCY<7:0>} \\
      \rowfont{\rmfamily\small}
      bit 7                 & 6                     & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF43} - SCX - Horizontal scroll register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \multicolumn8{|c|}{SCX<7:0>} \\
      \rowfont{\rmfamily\small}
      bit 7                 & 6                     & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF43} - LY - Scanline register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \multicolumn8{|c|}{LY<7:0>} \\
      \rowfont{\rmfamily\small}
      bit 7                 & 6                     & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF44} - LYC - Scanline compare register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \multicolumn8{|c|}{LYC<7:0>} \\
      \rowfont{\rmfamily\small}
      bit 7                 & 6                     & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }
\end{register}

\chapter{Port 1 (Joypad, Super Game Boy communication)}

\begin{register}[H]
  \caption{\texttt{\$FF00} - P1 - Joypad/Super Game Boy communication register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      U-1                     & U-1                     & W-0 & W-0 & R-x & R-x & R-x & R-x   \\
      \cellcolor{LightGray} - & \cellcolor{LightGray} - & P15 & P14 & P13 & P12 & P11 & P10   \\
      \rowfont{\rmfamily\small}
      bit 7                   & 6                       & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }

  \begin{description}[leftmargin=5em, style=nextline]
    \item[bit 7-6]
      \textbf{Unimplemented}: Read as \texttt{1}
    \item[bit 5]
      \textbf{P15}:
    \item[bit 4]
      \textbf{P14}:
    \item[bit 3]
      \textbf{P13}:
    \item[bit 2]
      \textbf{P12}:
    \item[bit 1]
      \textbf{P11}:
    \item[bit 0]
      \textbf{P10}:
  \end{description}
\end{register}

\chapter{Serial communication}

\begin{register}[H]
  \caption{\texttt{\$FF01} - SB - Serial data register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 & R/W-0 \\
      \multicolumn8{|c|}{SB<7:0>} \\
      \rowfont{\rmfamily\small}
      bit 7                 & 6                     & 5   & 4   & 3   & 2   & 1   & bit 0 \\
      \hline
    \end{tabu}
  }

  \begin{description}[leftmargin=5em, style=nextline]
    \item[bit 7-0]
      \textbf{SB<7:0>}: Serial data
  \end{description}
\end{register}

\begin{register}[H]
  \caption{\texttt{\$FF02} - SC - Serial control register}
  {
    \ttfamily
    \begin{tabu} to \textwidth {|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|X[c]|}
      \everyrow{\hline}
      \hline
      R/W-0  & U-1                     & U-1                     & U-1                     & U-1                     & U-1                     & U-1                     & R/W-0   \\
      SIO\_EN & \cellcolor{LightGray} - & \cellcolor{LightGray} - & \cellcolor{LightGray} - & \cellcolor{LightGray} - & \cellcolor{LightGray} - & \cellcolor{LightGray} - & SIO\_CLK \\
      \rowfont{\rmfamily\small}
      bit 7  & 6                       & 5                       & 4                       & 3                       & 2                       & 1                       & bit 0   \\
      \hline
    \end{tabu}
  }

  \begin{description}[leftmargin=5em, style=nextline]
    \item[bit 7]
      \textbf{SIO\_EN}:
    \item[bit 6-1]
      \textbf{Unimplemented}: Read as \texttt{1}
    \item[bit 0]
      \textbf{SIO\_CLK}:
  \end{description}
\end{register}

\part{Game Boy game cartridges}

\include{xx-mbc1}

\chapter{MBC2}

TODO.

\chapter{MBC3}

TODO.

\chapter{MBC5}

TODO.

\chapter{MBC6}

TODO.

\chapter{MBC7}

TODO.

\chapter{HuC-1}

TODO.

\chapter{HuC-3}

TODO.

\chapter{MMM01}

TODO.

\chapter{TAMA5}

TODO.

\part*{Appendices}
\addcontentsline{toc}{part}{Appendices}
\phantomsection

\begin{appendices}
\include{xx-opcode-tables}
\include{xx-memory-map}
\end{appendices}

\bibliography{gbctr}

\end{document}
